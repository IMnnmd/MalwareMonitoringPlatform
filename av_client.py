import subprocess
import socket
import base64
import os
import shutil
import calendar
import time

# SHARED FOLDER SAMPLES PATH
NET_PATH = '"Z:\\Shared\\Samples\\'

# VM FOLDER SAMPLES PATH
SAMPLE_PATH = 'C:\\Users\\AVHost\\Desktop\\Samples\\'

# SHARED FOLDER REPORTS PATH
REPORT_PATH = '"Z:\\Shared\\Reports\\'

CWD = os.path.abspath(os.curdir)

HEADER = 4
FORMAT = 'utf-8'

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.bind(('0.0.0.0', 4433))

sock.listen(3)

print('Binded sock')

commands = 0
kaspersky = None
eset = None
winav = None
flag = False
prev_filename = None
ts = ''


def process_msg(con, addr):
    global commands
    msg_len = con.recv(HEADER)
    msg_len = msg_len.decode(FORMAT)
    if msg_len:
        msg = base64.b64decode(con.recv(int(msg_len))).decode('utf-8')
        commands += 1
        return msg


def do_scan(name, params, file):
    params[0] = name
    try:
        print(' '.join(elem for elem in params))
        proc = subprocess.call(params, stdout=file, stderr=file, shell=True)
        return 'Next'
    except Exception:
        return 'Er-r'


def cpy_f(filename):
    global SAMPLE_PATH
    global NET_PATH
    global ts
    try:
        open(SAMPLE_PATH + filename)
        ts = calendar.timegm(time.gmtime())
        print('Gonna copy')
        shutil.copyfile(NET_PATH[1:] + filename, SAMPLE_PATH + filename + str(ts))
    except FileNotFoundError:
        print('NOTGonna copy')
        shutil.copyfile(NET_PATH[1:] + filename, SAMPLE_PATH + filename)


while True:
    con, addr = sock.accept()
    while con:
        res = process_msg(con, addr)
        if res == 'QUIT':
            flag = True
            break
        params = res.split(';')

        curr_filename = params[len(params) - 1]
        if curr_filename != prev_filename:
            cpy_f(curr_filename)
            prev_filename = curr_filename

        params[len(params) - 1] = SAMPLE_PATH + curr_filename + str(ts)
        params[len(params) - 2] = REPORT_PATH + params[len(params) - 2] + str(ts) + '"'

        try:
            file = open(os.path.join(CWD, params[len(params) - 2][1:-1]), 'w')
        except FileNotFoundError:
            file = open(params[0] + '.templog', 'w')
        params.remove(params[len(params) - 2])
        if res[0:3] == 'AVP':
            con.send(do_scan('AVP.com', params, file).encode(FORMAT))

        elif res[0:4] == 'ESET':
            con.send(do_scan('ecls', params, file).encode(FORMAT))

        elif res[0:5] == 'WinAV':
            con.send(do_scan('"%ProgramFiles%\Windows Defender\MpCmdRun.exe"', params, file).encode(FORMAT))
        file.close()

    if flag:
        sock.close()
        break
