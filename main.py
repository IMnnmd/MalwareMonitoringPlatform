import socket
import time
import base64
import report_parser
import hashlib
from datetime import datetime

REPORTS_PATH = 'D:\\машины\\Shared\\Reports\\'

#For future releases
#AV_list = {'AVP':'/?', 'ESET':'--help', 'WinAV':'-h'}

AV_list = {'AVP': 'SCAN;/i0',
           'ESET': '/no-quarantine;/adv-heur',
           'WinAV': '-Scan;-ScanType 3;-DisableRemediation;-File'}
results = []

HEADER = 4
FORMAT = 'utf-8'
PORT = 22825

av_machine_ip = '192.168.58.128'
cuckoo_machine_ip = '192.168.56.1'
cuckoo_port = 2042

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect((av_machine_ip, 4433))

while True:
    print('Файл берется из общей папки с машиной. Введите его имя:')
    filename = input()
    do_parse = True
    if filename == 'QUIT':
        msg = 'QUIT'
        base64_msg = base64.b64encode(msg.encode(FORMAT))
        msg_len = len(base64_msg)
        sock.send(('{:<}'.format(msg_len, HEADER)).encode(FORMAT))
        time.sleep(0.05)
        sock.send(base64_msg)
        sock.close()
        break

    for av in AV_list:

        msg = f'{av};{AV_list[av]};{filename}.{av};{filename}'
        base64_msg = base64.b64encode(msg.encode(FORMAT))
        msg_len = len(base64_msg)
        sock.send(('{:<}'.format(msg_len, HEADER)).encode(FORMAT))
        time.sleep(0.1)
        sock.send(base64_msg)
        response = sock.recv(HEADER).decode(FORMAT)
        if response == 'ER-2':
            print('File not found error')
            do_parse = False
            break
    if do_parse:
        results = report_parser.parse_results([filename + '.AVP', filename + '.ESET', filename + '.WinAV'], REPORTS_PATH)
        with open('Total reports.txt', 'a', encoding='utf-8') as file:
            file.write(datetime.now().strftime("%d/%m/%Y %H:%M:%S") + '\n')
            file.write(filename + '\n')
            for elem in results:
                file.write(f'{elem}: {results[elem]}\n')
            file.write('\n\n')
        print(results)

time.sleep(1)
print('Connection closed')