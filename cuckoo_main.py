import base64
import time
import json

HEADER = 4
FORMAT = 'utf-8'

REPORT_PATH = 'D:\\машины\\Shared\\Reports\\'


def cuckoo_thread(filename, sock, report_handle):

    msg = f'{filename}'
    base64_msg = base64.b64encode(msg.encode(FORMAT))
    msg_len = len(base64_msg)
    sock.send(('{:<}'.format(msg_len, HEADER)).encode(FORMAT))
    time.sleep(0.1)
    sock.send(base64_msg)
    while True:
        response = sock.recv(HEADER).decode(FORMAT)
        if response:
            break
    if response == 'ER-2':
        print('[CUCKOO]: File not found error')
        return response
    else:
        time.sleep(10)
        length = 16 * 1024 * 1024
        payload = ''
        with open(REPORT_PATH + filename + ".CUCKOO", "r") as report:
            while 1:
                buf = report.read(length)
                if not buf:
                    break
                payload += buf
            report_handle[1] = json.loads(payload)
        return "Next"
    sock.close()





